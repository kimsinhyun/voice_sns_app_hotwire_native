# 1. ì˜¤ë””ì˜¤ ëŒ€í™” ì½”ì–´ ë¡œì§ ìŠ¤í™ (v3 - ë‹¨ìˆœí™”)

## ë³€ê²½ ì´ë ¥
- **v1**: STI êµ¬ì¡°
- **v2**: Polymorphic êµ¬ì¡° + chat_participants í…Œì´ë¸”
- **v3**: chat_participants ì œê±°, 1:1 êµ¬ì¡° ë‹¨ìˆœí™”, Echo ì¤‘ì‹¬ ë¼ìš°íŒ…

---

## 1. ê°œìš” ë° ì„¤ê³„ ì˜ë„

ì´ ë¬¸ì„œëŠ” ë³´ì´ìŠ¤ SNSì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ 'ì˜¤ë””ì˜¤ ëŒ€í™”'ì˜ ë°ì´í„° ëª¨ë¸ê³¼ í•µì‹¬ ë¡œì§ì„ ìµœì¢…ì ìœ¼ë¡œ ì •ì˜í•©ë‹ˆë‹¤. 

### ì„¤ê³„ ëª©í‘œ ë° ì˜ë„

- **ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬ (Polymorphic ì±„íƒ ì´ìœ ):** 'í”¼ë“œì— ê³µê°œë˜ëŠ” ëª©ì†Œë¦¬(`Echo`)'ì™€ 'ëŒ€í™”ë°©ì˜ ë¹„ê³µê°œ ë©”ì‹œì§€(`Message`)'ëŠ” ë³¸ì§ˆì ìœ¼ë¡œ ë‹¤ë¥¸ ë§¥ë½ê³¼ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ë‹¤í˜•ì„± êµ¬ì¡°ëŠ” ì˜¤ë””ì˜¤ íŒŒì¼ ìì²´ë¥¼ ê´€ë¦¬í•˜ëŠ” `Recording` ëª¨ë¸ê³¼, ê° ì˜¤ë””ì˜¤ì˜ ë§¥ë½ì„ ì •ì˜í•˜ëŠ” `Echo`, `Message` ëª¨ë¸ì„ ëª…í™•íˆ ë¶„ë¦¬í•©ë‹ˆë‹¤.

- **Echo ì¤‘ì‹¬ ë¼ìš°íŒ…:** ëŒ€í™”ë°©ì€ í•­ìƒ íŠ¹ì • Echoë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹œì‘ë˜ë©°, `/echos/:id` ê²½ë¡œë¥¼ í†µí•´ ì ‘ê·¼í•©ë‹ˆë‹¤. ë³„ë„ì˜ `/chat_rooms/:id` ê²½ë¡œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°, Echo IDë¥¼ í†µí•´ ì„œë²„ì—ì„œ ChatRoomì„ ì‹ë³„í•©ë‹ˆë‹¤.

- **1:1 êµ¬ì¡° ë‹¨ìˆœí™”:** ëª¨ë“  ëŒ€í™”ëŠ” Echo ì‘ì„±ìì™€ ë‹µì¥ì ê°„ì˜ 1:1 êµ¬ì¡°ì…ë‹ˆë‹¤. chat_participants ì¤‘ê°„ í…Œì´ë¸” ì—†ì´ chat_roomsì— ì§ì ‘ ë‘ ì°¸ì—¬ì ì •ë³´ë¥¼ ì €ì¥í•˜ì—¬ êµ¬ì¡°ë¥¼ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤.

- **ë…ë¦½ì ì¸ ëŒ€í™”ë°©:** ëŒ€í™”ê°€ ì‹œì‘ë  ë•Œ, ì›ë³¸ `Echo`ì˜ ì˜¤ë””ì˜¤ íŒŒì¼ì„ **ë³µì‚¬**í•˜ì—¬ ëŒ€í™”ë°©ì˜ ì²« `Message`ë¡œ ë§Œë“­ë‹ˆë‹¤. ì´ë¡œì¨ `ChatRoom`ì€ ì‹œì‘ì ì´ì—ˆë˜ `Echo`ê°€ í”¼ë“œì—ì„œ ì‚¬ë¼ì§€ë”ë¼ë„ ì•„ë¬´ëŸ° ì˜í–¥ì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## 2. ë°ì´í„° ëª¨ë¸ êµ¬ì¡°

### `echos` í…Œì´ë¸”
- `id`: Primary Key
- `user_id`: ë©”ì•„ë¦¬ë¥¼ ë‚¨ê¸´ ì‚¬ìš©ì (FK)
- `created_at`, `updated_at`

### `chat_rooms` í…Œì´ë¸”
- `id`: Primary Key
- `echo_id`: ì–´ë–¤ `Echo`ë¡œë¶€í„° ì‹œì‘ë˜ì—ˆëŠ”ì§€ (FK to `echos`)
- `initiator_user_id`: Echo ì‘ì„±ì (FK to `users`)
- `responder_user_id`: ë‹µì¥í•œ ì‚¬ëŒ (FK to `users`)
- `initiator_left_at`: Echo ì‘ì„±ìê°€ ëŒ€í™”ë¥¼ ë– ë‚œ ì‹œê°„ (nullable)
- `responder_left_at`: ë‹µì¥ìê°€ ëŒ€í™”ë¥¼ ë– ë‚œ ì‹œê°„ (nullable)
- `last_message_at`: ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„ (ë¹„í™œì„± ì²˜ë¦¬ìš©)
- `created_at`, `updated_at`

### `messages` í…Œì´ë¸”
- `id`: Primary Key
- `user_id`: ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ì‚¬ìš©ì (FK)
- `chat_room_id`: ë©”ì‹œì§€ê°€ ì†í•œ ëŒ€í™”ë°© (FK)
- `created_at`, `updated_at`

### `recordings` í…Œì´ë¸”
- `id`: Primary Key
- `user_id`: ì˜¤ë””ì˜¤ë¥¼ ë…¹ìŒí•œ ì›ë³¸ ì‚¬ìš©ì (FK)
- `audio_file_data`: ì˜¤ë””ì˜¤ íŒŒì¼ (Active Storage)
- `belongable_type`: (String, "Echo", "Message")
- `belongable_id`: (Integer, `echos.id` or `messages.id`)
- `created_at`, `updated_at`

### ëª¨ë¸ ê´€ê³„
- `Echo`: `has_one :recording, as: :belongable, dependent: :destroy`, `belongs_to :user`, `has_many :chat_rooms`
- `Message`: `has_one :recording, as: :belongable, dependent: :destroy`, `belongs_to :user`, `belongs_to :chat_room`
- `Recording`: `belongs_to :belongable, polymorphic: true`, `belongs_to :user`
- `ChatRoom`: `belongs_to :echo`, `belongs_to :initiator, class_name: 'User'`, `belongs_to :responder, class_name: 'User'`, `has_many :messages`
- `User`: `has_many :echos`, `has_many :messages`, `has_many :chat_rooms_as_initiator`, `has_many :chat_rooms_as_responder`

---

## 3. í˜„ì¬ êµ¬í˜„ ìƒí™©

### âœ… Phase 1 ì™„ë£Œ
- Echo ëª¨ë¸ ë° Polymorphic Recording êµ¬ì¡° êµ¬ì¶•
- í”¼ë“œ(`/feed`)ì—ì„œ Echo ëª©ë¡ í‘œì‹œ
- Echo ìƒì„± ê¸°ëŠ¥ (ë„¤ì´í‹°ë¸Œ ì•± ì˜¤ë””ì˜¤ ë…¹ìŒ ì§€ì›)
- Pull-to-refresh, Infinite scroll
- Echoì™€ Recordingì˜ 1:1 ê´€ê³„ ì„¤ì •

### ğŸš§ Phase 2 ì§„í–‰ ì¤‘ (í˜„ì¬)
- ChatRoom, Message ëª¨ë¸ ìƒì„±
- Echo ìƒì„¸ í™”ë©´ (`/echos/:id`) êµ¬í˜„
- ë‹µì¥ì„ í†µí•œ ëŒ€í™”ë°© ìƒì„± ë¡œì§
- í„´ì œ ë©”ì‹œì§€ ì „ì†¡ ì œì•½
- ëŒ€í™”ë°© ëª©ë¡ (`/messages`)

### ğŸ“… Phase 3 (ì˜ˆì •)
- Reactions ê¸°ëŠ¥

### ğŸ“… Phase 4 (ì˜ˆì •)
- ì‹ ê³ /ì°¨ë‹¨ ê¸°ëŠ¥

### ğŸ“… Phase 5 (ì˜ˆì •)
- ìë™ íœ˜ë°œ ì‹œìŠ¤í…œ (Solid Queue)

---

## 4. í•µì‹¬ ë¡œì§ íë¦„ (Sequence)

### ê°€. í”¼ë“œì—ì„œ Echo í´ë¦­ (ë‹µì¥ ì‹œì‘)

**ì‚¬ìš©ì í”Œë¡œìš°:**
1. ì‚¬ìš©ì Bê°€ í”¼ë“œì—ì„œ ì‚¬ìš©ì Aì˜ Echo ì¹´ë“œ ì˜¤ë¥¸ìª½ í´ë¦­
2. `/echos/:echo_id`ë¡œ ì´ë™ (Turbo ê¸°ë³¸ ë„¤ë¹„ê²Œì´ì…˜)

**Echo ì¹´ë“œ êµ¬ì¡°:**
- ì™¼ìª½ ì˜ì—­: ì˜¤ë””ì˜¤ í”Œë ˆì´ ë²„íŠ¼
- ì˜¤ë¥¸ìª½ ì˜ì—­: Echo ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™ (ë‚¨ì´ ì˜¬ë¦° Echoë§Œ)
- ë‚´ê°€ ì˜¬ë¦° Echo: ì˜¤ë¥¸ìª½ ì˜ì—­ í´ë¦­ ë¶ˆê°€ (TODO: ë³µìˆ˜ ëŒ€í™”ë°© ëª©ë¡ í‘œì‹œ)

**Echo ìƒì„¸ í™”ë©´ ë¡œì§ (`EchosController#show`):**
```ruby
def show
  @echo = Echo.find(params[:id])
  
  # Case 1: ë‚´ê°€ ì˜¬ë¦° Echoì¸ ê²½ìš°
  if @echo.user == current_user
    # TODO: ë³µìˆ˜ ëŒ€í™”ë°© UI êµ¬í˜„
    # í˜„ì¬ëŠ” í•´ë‹¹ Echoë¡œë¶€í„° ìƒì„±ëœ ëª¨ë“  ChatRoom ëª©ë¡ í‘œì‹œ
    @chat_rooms = @echo.chat_rooms.order(last_message_at: :desc)
    @is_my_echo = true
    return
  end
  
  # Case 2: ë‚¨ì´ ì˜¬ë¦° Echoì¸ ê²½ìš°
  @chat_room = current_user.chat_rooms.find_by(echo_id: @echo.id)
  @messages = @chat_room ? @chat_room.messages.order(:created_at) : []
end
```

**í™”ë©´ êµ¬ì„±:**
- Echo ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ìƒë‹¨ ê³ ì •)
- ê¸°ì¡´ Message ëª©ë¡ (ìˆëŠ” ê²½ìš°)
- ë‹µì¥ ë…¹ìŒ UI (í•˜ë‹¨ footer)

### ë‚˜. ëŒ€í™” ì‹œì‘ (ì²« ë‹µì¥)

**íŠ¸ë¦¬ê±°:** ì‚¬ìš©ì Bê°€ `/echos/:echo_id`ì—ì„œ ë‹µì¥ì„ ë…¹ìŒí•˜ê³  ì „ì†¡

**í”„ë¡œì„¸ìŠ¤ (MessagesController#create - ë‹¨ì¼ DB íŠ¸ëœì­ì…˜):**
```ruby
def create
  @echo = Echo.find(params[:echo_id])
  
  # ChatRoomì´ ì—†ìœ¼ë©´ ìƒì„±
  @chat_room = current_user.chat_rooms.find_by(echo_id: @echo.id)
  
  if @chat_room.nil?
    ActiveRecord::Base.transaction do
      # ChatRoom ìƒì„±
      @chat_room = ChatRoom.create!(
        echo: @echo,
        initiator: @echo.user,
        responder: current_user,
        last_message_at: Time.current
      )
      
      # ì²« ë©”ì‹œì§€: Echo ì˜¤ë””ì˜¤ ë³µì‚¬
      first_message = @chat_room.messages.create!(user: @echo.user)
      first_recording = Recording.create!(user: @echo.user, belongable: first_message)
      first_recording.audio_file.attach(@echo.recording.audio_file.blob)
    end
  end
  
  # ë‘ë²ˆì§¸ ë©”ì‹œì§€: ë‹µì¥ ìƒì„±
  @message = @chat_room.messages.build(user: current_user)
  @recording = Recording.create!(user: current_user, belongable: @message)
  # audio_data ì²¨ë¶€...
end
```

**ê²°ê³¼:**
- Turbo Streamìœ¼ë¡œ Message append (í˜ì´ì§€ ì´ë™ ì—†ìŒ)
- `/echos/:echo_id`ì— ê·¸ëŒ€ë¡œ ë¨¸ë¬´ë¦„

### ë‹¤. ëŒ€í™” ì§„í–‰ (í„´ì œ)

**ì œì•½ ì¡°ê±´:**
```ruby
def create
  last_message = @chat_room.messages.order(:created_at).last
  
  if last_message && last_message.user_id == current_user.id
    # ì—ëŸ¬: ìƒëŒ€ë°©ì˜ ë‹µì¥ì„ ê¸°ë‹¤ë ¤ì•¼ í•¨
    return render_error("ìƒëŒ€ë°©ì˜ ë‹µì¥ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”")
  end
  
  # Message ìƒì„±...
end
```

### ë¼. ë‚´ê°€ ì˜¬ë¦° Echoì˜ ë³µìˆ˜ ëŒ€í™”ë°©

**Echo ì‘ì„±ì Aì˜ Echoì— B, C, Dê°€ ê°ê° ë‹µì¥:**
- ChatRoom 1: Echo(A) â†” B
- ChatRoom 2: Echo(A) â†” C
- ChatRoom 3: Echo(A) â†” D

**Aê°€ `/echos/:id`ì— ì ‘ê·¼ ì‹œ:**
- í•´ë‹¹ Echoë¡œë¶€í„° ìƒì„±ëœ ëª¨ë“  ChatRoom ëª©ë¡ í‘œì‹œ
- ê° ChatRoom í•­ëª©ì— responder ì •ë³´ ë° ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„ í‘œì‹œ
- TODO: ê° ChatRoom í´ë¦­ ì‹œ Message ëª©ë¡ í‘œì‹œ (Turbo Frame ì‚¬ìš©)

### ë§ˆ. ëŒ€í™”ë°© ëª©ë¡ (`/messages`)

**í‘œì‹œ ë‚´ìš©:**
```ruby
def index
  # ë‚¨ì´ ì˜¬ë¦° Echoì— ë‚´ê°€ ì°¸ì—¬í•œ ëŒ€í™”ë°©ë§Œ
  @chat_rooms = current_user.chat_rooms
                             .joins(:echo)
                             .where.not(echos: { user_id: current_user.id })
                             .order(last_message_at: :desc)
end
```

ê° ëŒ€í™”ë°© í•­ëª© í´ë¦­ â†’ `/echos/:echo_id`ë¡œ ì´ë™

**ë‚´ê°€ ì˜¬ë¦° Echoì˜ ëŒ€í™”ë°©:**
- í˜„ì¬ëŠ” ëª©ë¡ì—ì„œ ì œì™¸
- TODO: ë‚´ê°€ ì˜¬ë¦° Echoì˜ ëŒ€í™”ë°©ë„ ë³„ë„ë¡œ í‘œì‹œ

### ë°”. ëŒ€í™” ì¢…ë£Œ

**3ì¼ ë¹„í™œì„±:**
- ë°±ê·¸ë¼ìš´ë“œ ì¡ì´ `chat_rooms`ì˜ `last_message_at`ì„ ê¸°ì¤€ìœ¼ë¡œ 3ì¼ ì´ìƒ ì§€ë‚œ ëŒ€í™”ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì •ë¦¬ (Phase 5)

**ë°© ë‚˜ê°€ê¸°:**
- `initiator_left_at` ë˜ëŠ” `responder_left_at` ì—…ë°ì´íŠ¸
- ìƒëŒ€ë°©ì—ê²ŒëŠ” "ìƒëŒ€ë°©ì´ ëŒ€í™”ë¥¼ ë– ë‚¬ìŠµë‹ˆë‹¤" í‘œì‹œ
- ë‘ ì‚¬ëŒ ëª¨ë‘ ë– ë‚¬ìœ¼ë©´ ChatRoom ì‚­ì œ ê°€ëŠ¥

---

## 5. Footer ë…¹ìŒ UI Context

**Contextë³„ ë™ì‘:**
- `/feed`: Echo ìƒì„± (`submit_url: echos_path`)
- `/echos/:id`: Message ìƒì„± (`submit_url: echo_messages_path(@echo)`)
- `/messages`: ìˆ¨ê¹€ or ë¹„í™œì„±
- `/settings`: ìˆ¨ê¹€ or ë¹„í™œì„±

**êµ¬í˜„:**
```erb
<!-- app/views/shared/_footer.html.erb -->
<%= form_with(url: submit_url, ...) do |form| %>
  <!-- ë…¹ìŒ UI -->
<% end %>
```

---

## 6. ì‹ ê³  ë° ì°¨ë‹¨

- ë³„ë„ ë¬¸ì„œì—ì„œ ì •ì˜ë  ëª¨ë¸ì„ í†µí•´ ì²˜ë¦¬ (Phase 4)
- ì°¨ë‹¨ ì‹œ ê´€ë ¨ ChatRoomì˜ left_at ì—…ë°ì´íŠ¸í•˜ì—¬ ëª¨ë“  ìƒí˜¸ì‘ìš© ì¤‘ë‹¨

---

## 7. í–¥í›„ ê³ ë ¤ì‚¬í•­

- **í‘¸ì‹œ ì•Œë¦¼:** ë‹µì¥ ë„ì°© ì‹œ ì•Œë¦¼ (Phase 2ì—ì„œ ë¡œì§ ì¤€ë¹„, ì‹¤ì œ í‘¸ì‹œëŠ” ë‚˜ì¤‘ì—)
- **ì½ìŒ í‘œì‹œ:** í•„ìš” ì‹œ ì¶”ê°€ ê°€ëŠ¥
- **ìë™ íœ˜ë°œ:** Solid Queueë¥¼ í†µí•œ ìŠ¤ì¼€ì¤„ë§ (Phase 5)
- **Reactions:** ë¹„ê³µê°œ ë°˜ì‘ ì‹œìŠ¤í…œ (Phase 3)
