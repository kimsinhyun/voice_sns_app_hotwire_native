<%= turbo_refreshes_with method: :morph, scroll: :preserve %>

<!-- 로딩 오버레이 (로그인 전에만 표시) -->
<% unless user_signed_in? %>
  <div id="auth_overlay" class="fixed inset-0 bg-[#d6d5cc] flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-700 mx-auto"></div>
      <p class="mt-4 text-gray-600">로딩 중...</p>
      <p id="auth_error" class="hidden mt-2 text-red-600 text-sm">오류가 발생했습니다.</p>
    </div>
  </div>
<% end %>

<!-- Navigation bar를 숨기는 Bridge Component -->
<div data-controller="bridge--navigation-bar"
		 data-bridge--navigation-bar-hidden-value="true"
		 class="hidden"></div>

<div class="relative flex flex-col h-full" data-controller="pull-to-refresh infinite-scroll">
	<!-- Pull to refresh 스피너 -->
	<div data-pull-to-refresh-target="spinner" 
	     class="fixed top-0 left-1/2 -translate-x-1/2 z-50 
	            opacity-0 transition-all duration-300 pointer-events-none">
		<svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24">
			<circle class="opacity-25" cx="12" cy="12" r="10" 
			        stroke="currentColor" stroke-width="4"></circle>
			<path class="opacity-75" fill="currentColor" 
			      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
		</svg>
	</div>
	
	<!-- 스크롤 가능한 컨테이너 -->
	<div data-pull-to-refresh-target="container" 
	     class="flex-1 overflow-y-auto">
		<!-- 메인 콘텐츠 - 상단 safe area, 하단 recorder 높이만큼 패딩 (탭은 safe-area로 처리) -->
		<div class="px-4 py-4 pt-safe-or-4">
			<% if @echos&.any? %>
				<!-- 메아리 목록 -->
				<div id="echos_list" 
				     class="space-y-3"
				     data-latest-echo-id="<%= @echos.first&.id || 0 %>">
					<%= render partial: "feed/echo", collection: @echos, as: :echo %>
				</div>
				
				<!-- 스켈레톤 로더 컨테이너 -->
				<div id="skeleton_loader" class="hidden mt-3">
					<%= render partial: "shared/recording_skeleton" %>
				</div>
				
				<!-- Infinite Scroll Sentinel (감시 요소) -->
				<div id="infinite_scroll_sentinel" 
				     data-infinite-scroll-target="sentinel"
				     class="h-4 w-full"></div>
			<% else %>
				<div id="echos_list" 
				     class="space-y-3"
				     data-latest-echo-id="0">
					<p class="text-gray-500 text-center py-8">아직 메아리가 없습니다</p>
				</div>
			<% end %>
		</div>
	</div>
</div>

<!-- 컴팩트 녹음 툴바 - 화면 하단에 고정, safe-area로 탭 위에 자동 배치 -->
<!--<div class="fixed bottom-0 left-0 right-0 pb-safe z-50">-->
<%#= render partial: 'shared/compact_recorder', locals: { submit_url: recordings_path } %>
<!--</div>-->
