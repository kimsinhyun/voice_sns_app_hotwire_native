<%#= turbo_refreshes_with method: :morph, scroll: :preserve %>

<!-- Navigation bar를 숨기는 Bridge Component -->
<!--<div data-controller="bridge--navigation-bar"-->
<!--     data-bridge--navigation-bar-hidden-value="true"-->
<!--     class="hidden"></div>-->


<% if @is_my_echo %>
  <!-- 상단 고정 헤더 (뒤로가기 버튼) -->
  <div class="sticky top-0 z-10 bg-white/90 backdrop-blur-sm border-b border-gray-200">
    <%= link_to feed_index_path, class: "flex items-center gap-2 px-4 py-3 text-gray-700 hover:text-gray-900" do %>
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="font-medium">뒤로</span>
    <% end %>
  </div>

  <!-- Case 1: 내가 올린 Echo - 복수 대화방 목록 -->
  <div class="p-4 pb-safe-or-4">
    <h2 class="text-lg font-bold mb-4">이 메아리에 답장한 사람들</h2>
    
    <% if @chat_rooms.any? %>
      <% @chat_rooms.each do |chat_room| %>
        <%= link_to chat_room_path(chat_room), class: "block border p-3 mb-2 rounded bg-white hover:bg-gray-50 transition" do %>
          <p class="font-semibold"><%= chat_room.responder.email %></p>
          <p class="text-sm text-gray-500">
            마지막 메시지: <%= chat_room.last_message_at ? time_ago_in_words(chat_room.last_message_at) + " 전" : "없음" %>
          </p>
        <% end %>
      <% end %>
    <% else %>
      <p class="text-gray-500 text-center py-8">아직 답장이 없습니다</p>
    <% end %>
  </div>
<% else %>
  <!-- Case 2: 남이 올린 Echo - 1:1 대화 화면 -->
  <div class="flex flex-col h-[100svh]">
    <!-- 상단 고정 헤더 (뒤로가기 버튼) -->
    <div class="sticky top-0 z-10 bg-white/90 backdrop-blur-sm border-b border-gray-200 flex-shrink-0">
      <%= link_to feed_index_path, class: "flex items-center gap-2 px-4 py-3 text-gray-700 hover:text-gray-900" do %>
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span class="font-medium">뒤로</span>
      <% end %>
    </div>

    <!-- Echo 오디오 플레이어 -->
    <div class="flex-shrink-0 p-4 border-b bg-gray-50">
      <p class="text-sm text-gray-600 mb-2">원본 메아리:</p>
      <%= render partial: "feed/echo", locals: { echo: @echo } if @echo.recording&.audio_file&.attached? %>
    </div>
    
    <!-- Messages 목록 (스크롤 가능) -->
    <div class="flex-1 overflow-y-auto p-4 pb-safe-or-4" id="chat-messages">
      <% if @chat_room %>
        <!-- 이미 채팅방이 존재하면 구독 시작 -->
        <%= turbo_stream_from @chat_room %>
      <% end %>
      
      <% if @messages.any? %>
        <% @messages.each do |message| %>
          <%= render partial: "messages/message", locals: { message: message } %>
        <% end %>
      <% else %>
        <p class="text-gray-500 text-center py-8">답장을 보내 대화를 시작하세요</p>
      <% end %>
    </div>
  </div>

  <!-- Footer: 녹음 UI (조건부 렌더링) -->
  <% if @is_waiting_for_reply %>
    <%= render "shared/footer_waiting" %>
  <% else %>
    <%= render "shared/footer", submit_url: @submit_url %>
  <% end %>
<% end %>
